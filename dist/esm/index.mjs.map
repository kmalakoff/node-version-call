{"version":3,"sources":["index.ts"],"sourcesContent":["const path = require('path');\nconst fs = require('fs');\nconst tmpdir = require('os').tmpdir || require('os-shim').tmpdir;\nconst suffix = require('temp-suffix');\nconst spawnSync = require('cross-spawn-cb').sync;\nconst JSONBuffer = require('json-buffer');\nconst mkdirp = require('mkdirp');\nconst callFn = require('./callFn');\n\nexport interface JSONObject {\n  [x: string]: any;\n}\nexport type CallOptions = {\n  args?: any[];\n  env?: JSONObject;\n};\n\nconst localCallFile = path.join(__dirname, 'localCall.js');\n\nfunction unlinkSafe(filename) {\n  try {\n    fs.unlinkSync(filename);\n  } catch {\n    // skip\n  }\n}\n\nexport default function call(filePath: string, version: string, options: CallOptions = {}): any {\n  const args = options.args || [];\n  let res;\n  if (version === 'local') res = callFn(filePath, args);\n  else {\n    const temp = path.join(tmpdir(), 'nvc');\n    const input = path.join(temp, suffix('input'));\n    const output = path.join(temp, suffix('output'));\n\n    // store data to a file\n    const callData = { filePath, args };\n    mkdirp.sync(path.dirname(input));\n    fs.writeFileSync(input, JSONBuffer.stringify(callData));\n    unlinkSafe(output);\n\n    // call the function\n    const env = options.env || process.env;\n    spawnSync('nvu', [version, 'node', localCallFile, input, output], { env, stdio: 'string' });\n\n    // get data and clean up\n    res = JSONBuffer.parse(fs.readFileSync(output, 'utf8'));\n    unlinkSafe(input);\n    unlinkSafe(output);\n  }\n\n  // error res\n  if (res.error) {\n    const err = new Error(res.error.message);\n    if (res.error.stack) err.stack = res.error.stack;\n    throw err;\n  }\n  return res.value;\n}\n"],"names":["path","require","fs","tmpdir","suffix","spawnSync","sync","JSONBuffer","mkdirp","callFn","localCallFile","join","__dirname","unlinkSafe","filename","unlinkSync","call","filePath","version","options","args","res","temp","input","output","callData","dirname","writeFileSync","stringify","env","process","stdio","parse","readFileSync","error","err","Error","message","stack","value"],"mappings":"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"}