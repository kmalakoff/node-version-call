{"version":3,"sources":["index.ts"],"sourcesContent":["const path = require('path');\nconst fs = require('fs');\nconst tmpdir = require('os').tmpdir || require('os-shim').tmpdir;\nconst suffix = require('temp-suffix');\nconst mkdirp = require('mkdirp');\nconst spawnSync = require('cross-spawn-cb').sync;\nconst JSONBuffer = require('./json-buffer');\nconst callFn = require('./callFn');\n\nexport interface JSONObject {\n  [x: string]: any;\n}\nexport type CallOptions = {\n  args?: any[];\n  env?: JSONObject;\n};\n\nconst localCallFile = path.join(__dirname, 'localCall.js');\n\nfunction unlinkSafe(filename) {\n  try {\n    fs.unlinkSync(filename);\n  } catch {\n    // skip\n  }\n}\n\nexport default function call(filePath: string, version: string, options: CallOptions = {}): any {\n  const args = options.args || [];\n  let result;\n  if (version === 'local') result = callFn(filePath, args);\n  else {\n    const callData = { filePath, args };\n    const inputFile = path.join(tmpdir(), 'nvc', suffix('input'));\n    const outputFile = path.join(tmpdir(), 'nvc', suffix('output'));\n\n    // store data to a file\n    unlinkSafe(inputFile);\n    unlinkSafe(outputFile);\n    mkdirp.sync(path.dirname(inputFile));\n    fs.writeFileSync(inputFile, JSONBuffer.stringify(callData));\n\n    // call the function\n    const env = options.env || process.env;\n    spawnSync('nvu', [version, 'node', localCallFile, inputFile, outputFile], { env, stdio: 'string' });\n\n    // get data and clean up\n    result = JSONBuffer.parse(fs.readFileSync(outputFile, 'utf8'));\n    unlinkSafe(inputFile);\n    unlinkSafe(outputFile);\n  }\n\n  // result result\n  if (result.error) {\n    const err = new Error(result.error.message);\n    if (result.error.stack) err.stack = result.error.stack;\n    throw err;\n  }\n  return result.value;\n}\n"],"names":["call","filePath","version","options","args","result","callFn","callData","inputFile","path","join","tmpdir","suffix","outputFile","unlinkSafe","mkdirp","sync","dirname","fs","writeFileSync","JSONBuffer","stringify","env","process","spawnSync","localCallFile","stdio","parse","readFileSync","error","err","Error","message","stack","value","require","__dirname","filename","unlinkSync"],"mappings":"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"}