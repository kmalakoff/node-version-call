{"version":3,"file":"node-version-call.js","sources":["../../src/index.ts"],"sourcesContent":["const path = require('path');\nconst fs = require('fs');\nconst tmpdir = require('os').tmpdir || require('os-shim').tmpdir;\nconst suffix = require('temp-suffix');\nconst mkdirp = require('mkdirp');\nconst spawnSync = require('cross-spawn-cb').sync;\nconst JSONBuffer = require('./json-buffer');\nconst callFn = require('./callFn');\n\nexport interface JSONObject {\n  [x: string]: any;\n}\nexport type CallOptions = {\n  args?: any[];\n  env?: JSONObject;\n};\n\nconst localCallFile = path.join(__dirname, 'localCall.js');\n\nfunction unlinkSafe(filename) {\n  try {\n    fs.unlinkSync(filename);\n  } catch {\n    // skip\n  }\n}\n\nexport default function call(filePath: string, version: string, options: CallOptions = {}): any {\n  const args = options.args || [];\n  let result;\n  if (version === 'local') result = callFn(filePath, args);\n  else {\n    const callData = { filePath, args };\n    const inputFile = path.join(tmpdir(), 'nvc', suffix('input'));\n    const outputFile = path.join(tmpdir(), 'nvc', suffix('output'));\n\n    // store data to a file\n    unlinkSafe(inputFile);\n    unlinkSafe(outputFile);\n    mkdirp.sync(path.dirname(inputFile));\n    fs.writeFileSync(inputFile, JSONBuffer.stringify(callData));\n\n    // call the function\n    const env = options.env || process.env;\n    spawnSync('nvu', [version, 'node', localCallFile, inputFile, outputFile], { env, stdio: 'string' });\n\n    // get data and clean up\n    result = JSONBuffer.parse(fs.readFileSync(outputFile, 'utf8'));\n    unlinkSafe(inputFile);\n    unlinkSafe(outputFile);\n  }\n\n  // result result\n  if (result.error) {\n    const err = new Error(result.error.message);\n    if (result.error.stack) err.stack = result.error.stack;\n    throw err;\n  }\n  return result.value;\n}\n"],"names":["path","require","fs","tmpdir","suffix","mkdirp","spawnSync","sync","JSONBuffer","callFn","localCallFile","join","__dirname","unlinkSafe","filename","unlinkSync","call","filePath","version","options","args","result","callData","inputFile","outputFile","dirname","writeFileSync","stringify","env","process","stdio","parse","readFileSync","error","err","Error","message","stack","value"],"mappings":"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"}