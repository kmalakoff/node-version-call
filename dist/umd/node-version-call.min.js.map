{"version":3,"file":"node-version-call.min.js","sources":["../../src/index.ts"],"sourcesContent":["const path = require('path');\nconst fs = require('fs');\nconst tmpdir = require('os').tmpdir || require('os-shim').tmpdir;\nconst suffix = require('temp-suffix');\nconst mkdirp = require('mkdirp');\nconst spawnSync = require('cross-spawn-cb').sync;\nconst JSONBuffer = require('./json-buffer');\nconst callFn = require('./callFn');\n\nexport interface JSONObject {\n  [x: string]: any;\n}\nexport type CallOptions = {\n  args?: any[];\n  env?: JSONObject;\n};\n\nconst localCallFile = path.join(__dirname, 'localCall.js');\n\nfunction unlinkSafe(filename) {\n  try {\n    fs.unlinkSync(filename);\n  } catch {\n    // skip\n  }\n}\n\nexport default function call(filePath: string, version: string, options: CallOptions = {}): any {\n  const args = options.args || [];\n  let result;\n  if (version === 'local') result = callFn(filePath, args);\n  else {\n    const callData = { filePath, args };\n    const inputFile = path.join(tmpdir(), 'nvc', suffix('input'));\n    const outputFile = path.join(tmpdir(), 'nvc', suffix('output'));\n\n    // store data to a file\n    unlinkSafe(inputFile);\n    unlinkSafe(outputFile);\n    mkdirp.sync(path.dirname(inputFile));\n    fs.writeFileSync(inputFile, JSONBuffer.stringify(callData));\n\n    // call the function\n    const env = options.env || process.env;\n    spawnSync('nvu', [version, 'node', localCallFile, inputFile, outputFile], { env, stdio: 'string' });\n\n    // get data and clean up\n    result = JSONBuffer.parse(fs.readFileSync(outputFile, 'utf8'));\n    unlinkSafe(inputFile);\n    unlinkSafe(outputFile);\n  }\n\n  // result result\n  if (result.error) {\n    const err = new Error(result.error.message);\n    if (result.error.stack) err.stack = result.error.stack;\n    throw err;\n  }\n  return result.value;\n}\n"],"names":["path","require","fs","tmpdir","suffix","mkdirp","spawnSync","sync","JSONBuffer","callFn","localCallFile","join","__dirname","unlinkSafe","filename","unlinkSync","e","filePath","version","result","options","length","arguments","args","callData","inputFile","outputFile","dirname","writeFileSync","stringify","env","process","stdio","parse","readFileSync","error","err","Error","message","stack","value"],"mappings":"gPAAA,IAAMA,EAAOC,QAAQ,QACfC,EAAKD,QAAQ,MACbE,EAASF,QAAQ,MAAME,QAAUF,QAAQ,WAAWE,OACpDC,EAASH,QAAQ,eACjBI,EAASJ,QAAQ,UACjBK,EAAYL,QAAQ,kBAAkBM,KACtCC,EAAaP,QAAQ,iBACrBQ,EAASR,QAAQ,YAUjBS,EAAgBV,EAAKW,KAAKC,UAAW,gBAE3C,SAASC,EAAWC,GAClB,IACEZ,EAAGa,WAAWD,GACd,MAAME,YAKK,SAAcC,EAAkBC,OAEzCC,EAF0DC,EAAAA,UAAyBC,OAAA,QAAA,IAAAC,UAAA,GAAAA,UAAA,GAAF,GAC/EC,EAAOH,EAAQG,MAAQ,GAE7B,GAAgB,UAAZL,EAAqBC,EAASV,EAAOQ,EAAUM,OAC9C,CACH,IAAMC,EAAW,CAAEP,SAAAA,EAAUM,KAAAA,GACvBE,EAAYzB,EAAKW,KAAKR,IAAU,MAAOC,EAAO,UAC9CsB,EAAa1B,EAAKW,KAAKR,IAAU,MAAOC,EAAO,WAGrDS,EAAWY,GACXZ,EAAWa,GACXrB,EAAOE,KAAKP,EAAK2B,QAAQF,IACzBvB,EAAG0B,cAAcH,EAAWjB,EAAWqB,UAAUL,IAGjD,IAAMM,EAAMV,EAAQU,KAAOC,QAAQD,IACnCxB,EAAU,MAAO,CAACY,EAAS,OAAQR,EAAee,EAAWC,GAAa,CAAEI,IAAAA,EAAKE,MAAO,WAGxFb,EAASX,EAAWyB,MAAM/B,EAAGgC,aAAaR,EAAY,SACtDb,EAAWY,GACXZ,EAAWa,GAIb,GAAIP,EAAOgB,MAAO,CAChB,IAAMC,EAAM,IAAIC,MAAMlB,EAAOgB,MAAMG,SAEnC,MADInB,EAAOgB,MAAMI,QAAOH,EAAIG,MAAQpB,EAAOgB,MAAMI,OAC3CH,EAER,OAAOjB,EAAOqB"}